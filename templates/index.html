<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Web</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #login, #chat-area { margin-bottom: 20px; }
        #messages { list-style-type: none; padding: 0; margin: 0; height: 400px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        #messages li { padding: 8px; margin-bottom: 5px; }
        #messages li:nth-child(odd) { background-color: #f9f9f9; }
        .status-msg { color: #888; font-style: italic; text-align: center; }
        .my-msg { text-align: right; }
        .my-msg strong { color: #007bff; }
        .other-msg strong { color: #28a745; }
        input[type="text"] { width: calc(100% - 22px); padding: 10px; border: 1px solid #ddd; }
        button { padding: 10px 15px; border: none; background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        #chat-controls { display: flex; }
        #chat-controls input { flex-grow: 1; }
        #room-controls { display: flex; gap: 10px; margin-bottom: 10px;}
        #user-list { float: right; width: 150px; border-left: 1px solid #ddd; padding-left: 10px; height: 400px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Chat em Tempo Real com Flask</h1>
        
        <div id="login">
            <h3>Entrar no Chat</h3>
            <input type="text" id="username" placeholder="Seu nome de usuário">
            <button id="connect-btn">Conectar</button>
        </div>

        <div id="chat-area" style="display: none;">
            <div id="room-controls">
                <input type="text" id="room-name" placeholder="Nome da sala">
                <input type="text" id="room-password" placeholder="Senha (opcional)">
                <button id="create-room">Criar Sala</button>
                <button id="join-room">Entrar na Sala</button>
            </div>
            
            <h3 id="current-room-title"></h3>
            <ul id="messages"></ul>
            <div id="chat-controls">
                <input type="text" id="message_input" placeholder="Digite sua mensagem...">
                <button id="send-button">Enviar</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            let username = '';
            let currentRoom = '';

            const loginDiv = document.getElementById('login');
            const chatDiv = document.getElementById('chat-area');
            const connectBtn = document.getElementById('connect-btn');
            const usernameInput = document.getElementById('username');

            connectBtn.addEventListener('click', () => {
                const enteredUsername = usernameInput.value.trim();
                if (enteredUsername) {
                    username = enteredUsername;
                    loginDiv.style.display = 'none';
                    chatDiv.style.display = 'block';
                } else {
                    alert('Por favor, insira um nome de usuário.');
                }
            });

            // --- Lógica de Salas ---
            const createBtn = document.getElementById('create-room');
            const joinBtn = document.getElementById('join-room');
            const roomInput = document.getElementById('room-name');
            const passwordInput = document.getElementById('room-password');
            const roomTitle = document.getElementById('current-room-title');

            createBtn.addEventListener('click', () => {
                const room = roomInput.value.trim();
                if(room){
                    socket.emit('create', { room: room, password: passwordInput.value });
                    roomInput.value = '';
                    passwordInput.value = '';
                }
            });

            joinBtn.addEventListener('click', () => {
                const room = roomInput.value.trim();
                if(room){
                    currentRoom = room;
                    socket.emit('join', { username: username, room: room, password: passwordInput.value });
                    roomTitle.innerText = `Você está na sala: ${currentRoom}`;
                }
            });
            
            // --- Lógica de Mensagens ---
            const sendBtn = document.getElementById('send-button');
            const msgInput = document.getElementById('message_input');

            function sendMessage() {
                const msg = msgInput.value.trim();
                if (msg && currentRoom) {
                    socket.emit('text', { username: username, room: currentRoom, msg: msg });
                    msgInput.value = '';
                }
            }

            sendBtn.addEventListener('click', sendMessage);
            msgInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // --- Recebendo Eventos do Servidor ---
            const messages = document.getElementById('messages');

            socket.on('message', (data) => {
                const item = document.createElement('li');
                item.innerHTML = `<strong>${data.username}:</strong> ${data.msg}`;
                // Adiciona uma classe para estilizar as próprias mensagens de forma diferente
                if (data.username === username) {
                    item.classList.add('my-msg');
                } else {
                    item.classList.add('other-msg');
                }
                messages.appendChild(item);
                messages.scrollTop = messages.scrollHeight; // Auto-scroll
            });

            socket.on('status', (data) => {
                const item = document.createElement('li');
                item.classList.add('status-msg');
                item.innerText = data.msg;
                messages.appendChild(item);
                messages.scrollTop = messages.scrollHeight;
            });
            
            socket.on('error', (data) => {
                alert('Erro: ' + data.msg);
            });
        });
    </script>
</body>
</html>
